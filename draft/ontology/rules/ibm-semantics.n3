@prefix : <#> .
@prefix ibm: <http://tok450s.lan:8080/ldbbc/ibm-vocab.ttl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix sp: <http://spinrdf.org/sp#> .
@prefix sparql-result: <http://www.w3.org/2005/sparql-results#> .
@prefix http: <http://www.w3.org/2011/http#>.
@prefix http_m: <http://www.w3.org/2011/http-methods#>.

@prefix :       <http://tok450s.lan:8080/ldbbc/> .

@prefix this: <http://this.nxparser.github.io/reference/to/URI/of/current/rdf/graph/for/representing/permanently/relative/URIs/in/N-Triples/#> .
@prefix tmp:    <http://tok450s.lan:8080/ldbbc/> .
@prefix tmp_ha: <http://tok450s.lan:8080/ldbbc/#> . # because we cannot parse local names with 0 or 1 letter
@prefix webserver: <http://tok450s.lan:8080/ldbbc/> .


{ ?WfInstance a ibm:WorkflowInstance ; ibm:hasState ibm:uninitialized ; ibm:isInstanceOf ?td . }
=>
{ _:h http:mthd http_m:GET ; http:requestURI ?td . } . 

{ ?WfInstance a ibm:WorkflowInstance ; ibm:hasState ibm:initialized ; ibm:isInstanceOf ?td . }
=>
{ _:h http:mthd http_m:GET ; http:requestURI ?td . } . 

{ ?WfInstance a ibm:WorkflowInstance ; ibm:hasState ibm:active ; ibm:isInstanceOf ?td . }
=>
{ _:h http:mthd http_m:GET ; http:requestURI ?td . } . 

# Setup Workflow Instances() 
{ 
    ?WfInstance a ibm:WorkflowInstance ;
                ibm:hasState ibm:uninitialized ;
                ibm:isInstanceOf ?WfModel . 
                ?WfModel ibm:containsStageModel ?stage .
                ?stage ibm:hasTaskModel ?taskModel .
}
=>
{
    _:h3 http:mthd http_m:PUT ; 
        http:requestURI ?WfInstance ; 
        http:body { 
            this:it ibm:isInstanceOf ?WfModel ;
            ibm:hasState ibm:active . 
        } .
} .
# Setup Stage Instances
{ 
    ?WfInstance a ibm:WorkflowInstance ;
                ibm:hasState ibm:uninitialized ;
                ibm:isInstanceOf ?WfModel . 
                ?WfModel ibm:containsStageModel ?stage .
                ?stage ibm:hasTaskModel ?taskModel .
}
=>
{
    _:h1 http:mthd http_m:POST ; 
        http:requestURI <http://tok450s.lan:8080/ldbbc/> ; 
        http:body {
            this:StageInstance ibm:isInstanceOf ?stage ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?WfInstance . 
        } . 
} .
# Setup Task Instances
{ 
    ?WfInstance a ibm:WorkflowInstance ;
                ibm:hasState ibm:uninitialized ;
                ibm:isInstanceOf ?WfModel . 
                ?WfModel ibm:containsStageModel ?stage .
                ?stage ibm:hasTaskModel ?taskModel .
}
=>
{
    _:h2 http:mthd http_m:POST ; 
        http:requestURI <http://tok450s.lan:8080/ldbbc/> ; 
        http:body { 
            this:TaskInstance ibm:isInstanceOf ?taskModel ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?WfInstance . 
        } .
    
} .
# Setup Milestone Instances
{ 
    ?WfInstance a ibm:WorkflowInstance ;
                ibm:hasState ibm:uninitialized ;
                ibm:isInstanceOf ?WfModel . 
    ?WfModel ibm:containsStageModel ?stage .
    ?stage ibm:hasMilestoneModel ?milestoneModel .
}
=>
{
    _:h2 http:mthd http_m:POST ; 
        http:requestURI <http://tok450s.lan:8080/ldbbc/> ; 
        http:body { 
            this:MilestoneInstance ibm:isInstanceOf ?milestoneModel ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?WfInstance . 
        } .
} .


# get precondition data
{
    ?where  sp:subject          ?subject .
}
=>
{
    _:h     http:mthd               http_m:GET; 
            http:requestURI         ?subject .
} .

# execute active tasks
# we need this rule for every supported kind of http method
# (PUT, POST at least), see annotation below
# 
{
    ?taskInstance ibm:inWorkflowInstance ?wfInstance ;
        ibm:isInstanceOf ?taskModel ;
        ibm:hasState ibm:active .

    ?taskModel ibm:hasHttpRequest ?httpRequest .

    ?httpRequest a http:Request ;
        http:mthd ?httpMthd ;
        http:requestURI ?httpUri ;
        http:body ?httpBody .
} 
=> 
{
    _:h     http:mthd http_m:POST ;  # ?httpMthd breaks ldfu...
            http:requestURI ?httpUri ; 
            http:body ?httpBody . 

    _:h2    http:mthd http_m:PUT ;
            http:requestURI ?taskInstance ;
            http:body {
                ?taskInstance ibm:isInstanceOf ?taskModel ;
                ibm:hasState ibm:done ;
                ibm:inWorkflowInstance ?WfInstance .
            } .
} .
# Set executed task to done
{
    ?taskInstance ibm:inWorkflowInstance ?wfInstance ;
        ibm:isInstanceOf ?taskModel ;
        ibm:hasState ibm:active .

    ?taskModel ibm:hasHttpRequest ?httpRequest .

    ?httpRequest a http:Request ;
        http:mthd ?httpMthd ;
        http:requestURI ?httpUri ;
        http:body ?httpBody .
} 
=> 
{
    _:h2    http:mthd http_m:PUT ;
            http:requestURI ?taskInstance ;
            http:body {
                ?taskInstance ibm:isInstanceOf ?taskModel ;
                ibm:hasState ibm:done ;
                ibm:inWorkflowInstance ?wfInstance .
            } .
} .

# PAC-1

{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStageModel ?stageModel .
    ?stageModel ibm:hasGuard ?guard .

    # Prerequisite
    ?stageInstance ibm:isInstanceOf ?stage .
    ?stageInstance ibm:hasState ibm:inactive .

    # Antecedent
    ?guard ibm:hasCondition ?sentry .
    ?sentry sparql-result:boolean "true"^^xsd:boolean .
    ?wfInstance ibm:hasState ibm:active .
} 
=> 
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?stageInstance ; 
        http:body {
            ?stageInstance ibm:isInstanceOf ?stage ;
            ibm:hasState ibm:active ;
            ibm:inWorkflowInstance ?wfInstance .
        } . 
} .

# PAC-2
{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStageModel ?stageModel .
    ?stageModel ibm:hasMilestoneModel ?milestone .
    ?milestone ibm:hasValidatingSentry ?sentry .
    ?milestoneInstance ibm:isInstanceOf ?milestone .

    # Prerequisite
    ?stageInstance ibm:isInstanceOf ?stage ;
                    ibm:hasState ibm:active .

    # Antecedent
    ?sentry sparql-result:boolean "true"^^xsd:boolean .
}
=>
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?milestoneInstance ; 
        http:body {
            ?milestoneInstance ibm:isInstanceOf ?milestone ;
            ibm:hasState ibm:active ;
            ibm:inWorkflowInstance ?wfInstance .
        } . 
} .

# PAC-3
{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .
    ?stage ibm:hasMilestoneModel ?milestone .
    ?milestone ibm:hasInvalidatingSentry ?sentry .
    ?milestoneInstance ibm:isInstanceOf ?milestone .

    # Prerequisite
    ?milestoneInstance ibm:hasState ibm:active .

    # Antecedent
    ?sentry sparql-result:boolean "true"^^xsd:boolean .
}
=>
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?milestoneInstance ; 
        http:body {
            ?milestoneInstance ibm:isInstanceOf ?milestone ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?wfInstance .
        } . 
} .

# PAC-4
{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .
    ?stage ibm:hasMilestoneModel ?milestone ;
            ibm:hasGuard ?guard .
    
    # Prerequisite
    ?milestoneInstance ibm:isInstanceOf ?milestone ;
                        ibm:hasState ibm:active .

    # Antecedent
    ?guard ibm:hasCondition ?sentry .
    ?sentry sparql-result:boolean "true"^^xsd:boolean .
    ?wfInstance ibm:hasState ibm:active .
} 
=>
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?milestoneInstance ; 
        http:body {
            ?milestoneInstance ibm:isInstanceOf ?milestone ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?wfInstance .
        } .
} .

# PAC-5
{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .
    ?stage ibm:hasMilestoneModel ?milestone .
    ?milestone ibm:hasCondition ?sentry .

    # Prerequisite
    ?stageInstance ibm:isInstanceOf ?stage ;
                    ibm:hasState ibm:active .

    # Antecedent
    ?sentry sparql-result:boolean "true"^^xsd:boolean .
}
=>
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?stageInstance ; 
        http:body {
            ?stageInstance ibm:isInstanceOf ?stage ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?wfInstance .
        } . 
} .

# PAC-6
{
    # Basis
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .
    ?wfInstance ibm:isInstanceOf ?wfModel .
    ?wfModel ibm:containsStage ?stage .

    # Prerequisite
    ?stageInstance ibm:isInstanceOf ?stage .
    ?stageInstance ibm:hasState ibm:active .

    # Antecedent
    ?wfInstance ibm:hasState ibm:inactive .
}
=>
{
    # Consequent
    _:h http:mthd http_m:PUT ; 
        http:requestURI ?stageInstance ; 
        http:body {
            ?stageInstance ibm:isInstanceOf ?stage ;
            ibm:hasState ibm:inactive ;
            ibm:inWorkflowInstance ?wfInstance .
        } . 
} .