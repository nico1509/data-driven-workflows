@prefix : <#> .
@prefix ibm: <http://ldbbc-server.lan/ldbbc/ibm-vocab.ttl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd:   <http://www.w3.org/2001/XMLSchema#> .
@prefix sp: <http://spinrdf.org/sp#> .
@prefix sparql-result: <http://www.w3.org/2005/sparql-results#> .
@prefix http: <http://www.w3.org/2011/http#>.
@prefix http_m: <http://www.w3.org/2011/http-methods#>.


# check preconditions

{
    ?stage ibm:hasGuards        ?guard .
    ?guard ibm:hasPreCondition  ?sentry .
    ?sentry sparql-result:boolean "true"^^xsd:Boolean .
}
=>
{   
    ?stage ibm:hasState ibm:active . 
} .


# execute stages

{
    ?stage      ibm:hasState        ibm:active ;
                ibm:hasTask         ?task .
    ?task       ibm:hasAction       ?action .
    ?action     ibm:hasHttpRequest  ?request .
    #    ibm:hasHttpRequest ?request .
    ?request    http:mthd           http_m:POST ; 
                http:requestURI     ?uri ; 
                http:body           ?body .
} => {
    #### perform action 
    _:h http:mthd       http_m:POST ;                 
        http:requestURI ?uri ; 
        http:body       ?body .             ### QUESTION: react on non 3XX Responses

    #### set action state => done           ### QUESTION: valid? is property value overwritten or is a duplicate property added
    ?action     ibm:hasState ibm:done;
} .

##### QUESTION: how does this rule start executing??
{

    ?stage      ibm:hasState        ibm:active ;
                ibm:hasTask         ?task .
    ?task       ibm:hasAction       ?action .
    ?action     ibm:hasState        ibm:done
                ibm:hasNextAction   ?nextAction .
    ?nextAction ibm:hasState        ibm:open .
                ibm:hasHttpRequest  ?request .
    ?request    http:mthd           http_m:POST ; 
                http:requestURI     ?uri ; 
                http:body           ?body .

} => {
    ### perform action 
    _:h http:mthd       http_m:POST ;                 
        http:requestURI ?uri ; 
        http:body       ?body .              ### QUESTION: react on non 3XX Responses

    ### set action state => done
    ?action     ibm:hasState ibm:done;
}

{

    ?stage      ibm:hasState        ibm:active ;
                ibm:hasTask         ?task .
    ?task       ibm:hasAction       ?action .
    ?action     ibm:hasState        ibm:done
                ibm:hasNextAction   rdf:nil . #### QUESTION: is this valid for a missing next action (last item in row)
} => {
    #### set stage state => done
    ?stage      ibm:hasState    
}

# check postconditions

{
    ?stage ibm:hasMilestone ?milestone .
    ?milestone ibm:hasPostCondition ?sentry .
    ?sentry sparql-result:boolean "true"^^xsd:Boolean .
} 
=> 
{ 
    ?stage ibm:hasState ibm:done . 
} .